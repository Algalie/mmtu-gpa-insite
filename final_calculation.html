{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Final GPA Calculation</h1>
    <p class="subtitle">Calculate your final GPA by combining two semesters</p>
    
    <div class="final-calculation-card">
        <h2>Select Semesters</h2>
        
        <form id="finalCalculationForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="first_semester">First Semester:</label>
                    <select id="first_semester" name="first_semester" required class="semester-select">
                        <option value="">-- Select First Semester --</option>
                        {% for record in saved_records %}
                        <option value="{{ record.id }}">{{ record.title }} - GPA: {{ record.gpa }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="second_semester">Second Semester:</label>
                    <select id="second_semester" name="second_semester" required class="semester-select">
                        <option value="">-- Select Second Semester --</option>
                        {% for record in saved_records %}
                        <option value="{{ record.id }}">{{ record.title }} - GPA: {{ record.gpa }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-actions">
    <button type="button" id="calculateFinalBtn" class="btn btn-primary">Calculate Final GPA</button>
    <a href="{{ url_for('final_records') }}" class="btn btn-secondary">View Final Records</a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>
        </form>
    </div>
    
    <div id="finalResult" class="result-card" style="display: none;">
        <h2>Final GPA Result</h2>
        <div class="gpa-display" id="finalGpaDisplay">0.00</div>
        <div class="status-message" id="finalStatusMessage"></div>
        <div class="result-details">
            <div class="semester-breakdown">
                <div class="semester-item">
                    <strong>First Semester GPA:</strong>
                    <span id="firstSemesterGpa">0.00</span>
                </div>
                <div class="semester-item">
                    <strong>Second Semester GPA:</strong>
                    <span id="secondSemesterGpa">0.00</span>
                </div>
                <div class="semester-item final">
                    <strong>Final GPA:</strong>
                    <span id="calculatedFinalGpa">0.00</span>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" onclick="openSaveFinalModal()" class="btn btn-primary">Save Final Result</button>
            <button type="button" onclick="resetCalculation()" class="btn btn-secondary">New Calculation</button>
        </div>
    </div>
</div>

<!-- Save Final GPA Modal -->
<div id="saveFinalModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Save Final GPA Result</h3>
        <form id="saveFinalForm" onsubmit="saveFinalResult(event)">
            <div class="form-group">
                <label for="final_title">Title *:</label>
                <input type="text" id="final_title" name="title" placeholder="e.g., Year 1 Final GPA" required>
            </div>
            
            <div class="form-group">
                <label for="final_notes">Notes:</label>
                <textarea id="final_notes" name="notes" placeholder="Optional notes..."></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Final Result</button>
                <button type="button" onclick="closeSaveFinalModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calculateBtn = document.getElementById('calculateFinalBtn');
    const firstSelect = document.getElementById('first_semester');
    const secondSelect = document.getElementById('second_semester');
    
    calculateBtn.addEventListener('click', calculateFinalGPA);
    
    // Prevent selecting same semester for both
    firstSelect.addEventListener('change', function() {
        if (this.value && this.value === secondSelect.value) {
            alert('Please select different semesters for calculation');
            this.value = '';
        }
    });
    
    secondSelect.addEventListener('change', function() {
        if (this.value && this.value === firstSelect.value) {
            alert('Please select different semesters for calculation');
            this.value = '';
        }
    });
});

function calculateFinalGPA() {
    const firstSemesterId = document.getElementById('first_semester').value;
    const secondSemesterId = document.getElementById('second_semester').value;
    
    if (!firstSemesterId || !secondSemesterId) {
        alert('Please select both semesters');
        return;
    }
    
    if (firstSemesterId === secondSemesterId) {
        alert('Please select different semesters');
        return;
    }
    
    const calculateBtn = document.getElementById('calculateFinalBtn');
    const originalText = calculateBtn.textContent;
    
    calculateBtn.disabled = true;
    calculateBtn.textContent = 'Calculating...';
    
    fetch('/calculate-final-gpa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            first_semester_id: firstSemesterId,
            second_semester_id: secondSemesterId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayFinalResult(data);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during calculation');
    })
    .finally(() => {
        calculateBtn.disabled = false;
        calculateBtn.textContent = originalText;
    });
}

function displayFinalResult(data) {
    document.getElementById('firstSemesterGpa').textContent = data.first_gpa;
    document.getElementById('secondSemesterGpa').textContent = data.second_gpa;
    document.getElementById('calculatedFinalGpa').textContent = data.final_gpa;
    document.getElementById('finalGpaDisplay').textContent = data.final_gpa;
    document.getElementById('finalStatusMessage').textContent = data.status;
    
    document.getElementById('finalResult').style.display = 'block';
    
    // Scroll to result
    document.getElementById('finalResult').scrollIntoView({ behavior: 'smooth' });
}

function openSaveFinalModal() {
    document.getElementById('saveFinalModal').style.display = 'flex';
    document.getElementById('final_title').focus();
}

function closeSaveFinalModal() {
    document.getElementById('saveFinalModal').style.display = 'none';
    document.getElementById('saveFinalForm').reset();
}

function saveFinalResult(event) {
    event.preventDefault();
    
    const title = document.getElementById('final_title').value.trim();
    if (!title) {
        alert('Please enter a title for your final result');
        return;
    }
    
    const formData = new FormData(document.getElementById('saveFinalForm'));
    const saveButton = document.querySelector('#saveFinalForm button[type="submit"]');
    const originalText = saveButton.textContent;
    
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    fetch('/save-final-gpa', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/final-records';
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    });
}

function resetCalculation() {
    document.getElementById('finalCalculationForm').reset();
    document.getElementById('finalResult').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('saveFinalModal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeSaveFinalModal();
    }
});
</script>
{% endblock %}
